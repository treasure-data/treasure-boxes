_export:
  output_database: ml_test
  td:
    engine: presto
    database: ${output_database}

+create_db_tbl_if_not_exists:
  td_ddl>:
  create_databases: ["ml_test"]

+load_datasets:
  ipynb>:
    docker:
      task_mem: 64g # 64g/128g/256g/384g/512g
    notebook: ml_datasets
    output_database: ml_datasets
    datasets: vehicle_coupon

+train:
  ml_train>:
    docker:
      task_mem: 256g # 64g/128g/256g/384g/512g
    notebook: gluon_train
    model_name: gluon_model_${session_id}
    input_table: ml_datasets.vehicle_coupon_train
    target_column: y
    time_limit: 3 * 60 # 3 min

+prepare_input:
  td>: queries/assign_rowid.sql
  table: ml_datasets.vehicle_coupon_test
  rowid_column: userid
  create_table: ml_datasets.vehicle_coupon_test_with_rowid
  engine: hive

+create_master_segment:
  py>: scripts.audience.create_master_segment
  name: vehicle_coupon_${session_id}
  # description: xxx
  master:
    database: ml_datasets
    table: vehicle_coupon_test_with_rowid
  run: false
  docker:
    image: "digdag/digdag-python:3.9"
  _env:
    TD_API_KEY: ${secret:td.apikey}
    TD_API_SERVER: "api.treasuredata.com"

+predict:
  ml_predict>:
    docker:
      task_mem: 128g # 64g/128g/256g/384g/512g
    notebook: gluon_predict
    model_name: gluon_model_${session_id}
    input_table: ml_datasets.vehicle_coupon_test_with_rowid
    rowid_column: userid
    output_table: ${output_database}.predicted_${session_id}
    audience_name: vehicle_coupon_${session_id}
    foreign_key: userid
